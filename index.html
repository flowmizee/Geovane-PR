<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedido de Delivery</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #002a7b; /* Azul #002a7b */
      margin: 20px;
      background-image: radial-gradient(circle at center bottom, rgba(255,255,255,0.3) 20%, rgba(255,255,255,0) 100%);
      background-size: cover;
    }
    h1 {
      text-align: center;
      color: white; /* Cor do texto do título */
    }
    form {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px; /* Espaçamento interno do formulário */
      background-color: #000; /* Preto para o formulário */
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      color: white; /* Cor do texto em branco */
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, select, textarea {
      width: calc(100% - 20px); /* Ajusta a largura para ter padding */
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #333; /* Cinza um pouco mais claro para contraste */
      color: white;
    }
    .item-row {
      display: flex;
      gap: 10px;
      padding: 10px; /* Espaçamento interno da linha */
    }
    .item-row select, .item-row input {
      width: 32%;
      background-color: #000; /* Preto */
    }
    .add-item {
      text-align: center;
      margin-bottom: 15px;
    }
    .taxa-fixa {
      background-color: #333; /* Mesma cor do formulário */
      border: none;
      color: white;
      font-weight: bold;
    }
    button {
      padding: 8px 15px; /* Diminui o espaçamento interno */
      background-color: #002a7b; /* Azul do fundo da página */
      color: white;
      font-size: 14px; /* Diminui o tamanho da fonte */
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #001e56; /* Azul mais escuro */
      transition: background-color 0.3s ease; /* Adiciona transição suave */
    }
    /* Adiciona o estilo para a área de observações */
    textarea {
      background-color: #000; /* Preto */
    }
    /* Estilo específico para o botão "Remover" */
    .item-row button {
      width: 32%; /* Mesma largura dos outros elementos */
      padding: 8px 15px; /* Mesma altura e padding */
      font-size: 14px; /* Mesma fonte */
    }
    /* Estilo para o botão "Adicionar Item" */
    .add-item button,
    form button[type="submit"] {
      width: 100%; /* Ocupa toda a largura da div */
      padding: 12px 20px; /* Aumenta o padding */
      font-size: 16px; /* Aumenta o tamanho da fonte */
    }
    .status-container {
      background-color: #000;
      color: #fff;
      padding: 25px 50px;
      border-radius: 8px;
      text-align: center;
      margin: 30px auto;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      max-width: 600px;
    }
    .status-container.fechado {
      background-color: #000;
      color: #fff;
      font-size: 24px;
    }
    .status-container.aberto {
      background-color: #000;
      color: #fff;
      font-size: 24px;
    }
    /* Estilo para os botões de opção Entrega/Retirada */
    #opcao-entrega {
      text-align: center;
      margin-bottom: 15px;
    }
    #opcao-entrega button {
      width: 45%;
      margin: 0 2%;
      padding: 10px;
      font-size: 16px;
    }
    #opcao-entrega button.selected {
      background-color: #001e56;
    }
  </style>
  <script>
    // Variável para guardar a opção selecionada: "entrega" ou "retirada"
    let opcaoEntrega = "entrega"; // padrão

    // Objeto que armazenará os produtos carregados da planilha
    const produtos = {}; // Inicialmente vazio

    // Função para carregar os dados da planilha do Google Sheets (CSV)
    async function carregarProdutosDaPlanilha() {
      // URL da sua planilha publicada em formato CSV:
      const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQrtGErWiwjhuVjEZgUe-6WbKpgCe8vxS1RiFXJ8QUcPthAtb0oCJJHbBX55oDghCNI_dIXz2_i4sVr/pub?output=csv";
      try {
        const resposta = await fetch(url);
        const csvText = await resposta.text();
        // Divide o CSV em linhas e remove as linhas vazias
        const linhas = csvText.split("\n").map(linha => linha.trim()).filter(linha => linha);
        // Remove a primeira linha (cabeçalho)
        linhas.shift();
        // Limpa o objeto produtos antes de adicionar os novos dados
        for (const key in produtos) {
          delete produtos[key];
        }
        // Para cada linha, assumindo que as colunas são: Nome do Produto, Preço, Emoji
        linhas.forEach(linha => {
          const colunas = linha.split(",").map(coluna => coluna.trim());
          const nome = colunas[0];
          // Substitua vírgula por ponto se necessário para o preço
          const preco = parseFloat(colunas[1].replace(",", "."));
          const emoji = colunas[2];
          // Atualiza o objeto produtos
          produtos[nome] = { preco, emoji };
        });
        console.log("Produtos carregados da planilha:", produtos);
        // Atualiza os selects dos itens já existentes para mostrar as opções atualizadas
        atualizarSelectProdutos();
      } catch (error) {
        console.error("Erro ao carregar os produtos da planilha:", error);
      }
    }

    // Função para atualizar os selects de produto, preservando o valor selecionado se existir
    function atualizarSelectProdutos() {
      const selects = document.querySelectorAll("#itens-container .item-row select:first-child");
      selects.forEach(select => {
        const currentValue = select.value; // Armazena o valor atual
        let optionsHTML = `<option value="">Selecione o produto</option>`;
        optionsHTML += Object.keys(produtos)
          .map(produto => `<option value="${produto}">${produtos[produto].emoji} ${produto} - R$ ${produtos[produto].preco.toFixed(2)}</option>`)
          .join('');
        select.innerHTML = optionsHTML;
        // Restaura o valor selecionado, se ele existir nas novas opções
        if (currentValue && optionsHTML.indexOf(`value="${currentValue}"`) !== -1) {
          select.value = currentValue;
        }
      });
    }

    // Função para selecionar a opção de entrega ou retirada
    function selecionarOpcao(opcao) {
      opcaoEntrega = opcao;
      document.getElementById("btn-entrega").classList.remove("selected");
      document.getElementById("btn-retirada").classList.remove("selected");
      if (opcao === "entrega") {
        document.getElementById("btn-entrega").classList.add("selected");
      } else {
        document.getElementById("btn-retirada").classList.add("selected");
      }
      calcularTotal();
    }

    // Chama a função para carregar os produtos da planilha quando o DOM estiver pronto
    window.addEventListener('DOMContentLoaded', function() {
      carregarProdutosDaPlanilha();
      atualizarStatus(); // Inicia a atualização do status
    });

    // Função para adicionar um novo item no pedido
    function adicionarItem() {
      const itensContainer = document.getElementById("itens-container");
      const novoItem = document.createElement("div");
      novoItem.className = "item-row";
      novoItem.innerHTML = `
        <select onchange="atualizarPrecoTotal(this)">
          <option value="">Selecione o produto</option>
          ${Object.keys(produtos)
            .map(produto => `<option value="${produto}">${produtos[produto].emoji} ${produto} - R$ ${produtos[produto].preco.toFixed(2)}</option>`)
            .join('')}
        </select>
        <select onchange="atualizarPrecoTotal(this)">
          ${[...Array(10)].map((_, i) => `<option value="${i + 1}">Quantidade: ${i + 1}</option>`).join('')}
        </select>
        <input type="number" placeholder="Preço Total (R$)" step="0.01" readonly>
        <button onclick="removerItem(this)">Remover</button>
      `;
      itensContainer.appendChild(novoItem);
      // Atualiza o select deste novo item, caso os produtos já tenham sido carregados
      atualizarSelectProdutos();
    }

    // Função para atualizar o preço total do item
    function atualizarPrecoTotal(selectElement) {
      const itemRow = selectElement.parentElement;
      const produto = itemRow.querySelector('select:nth-child(1)').value;
      const quantidade = itemRow.querySelector('select:nth-child(2)').value;
      if (produto && quantidade) {
        const precoTotal = (produtos[produto].preco * quantidade).toFixed(2);
        itemRow.querySelector('input').value = precoTotal;
        calcularTotal();
      } else {
        itemRow.querySelector('input').value = '';
        calcularTotal();
      }
    }

    // Função para calcular o total do pedido
    function calcularTotal() {
      const itensContainer = document.getElementById("itens-container").children;
      let total = 0;
      if (itensContainer.length > 0) {
        for (let i = 0; i < itensContainer.length; i++) {
          const item = itensContainer[i].children;
          const precoTotal = parseFloat(item[2].value) || 0;
          total += precoTotal;
        }
      }
      // Se a opção for retirada, a taxa é zero
      const taxaEntrega = opcaoEntrega === "retirada" ? 0 : parseFloat(document.getElementById("taxa").value) || 0;
      const totalPedido = total + taxaEntrega;
      document.getElementById("total").value = totalPedido.toFixed(2);
    }

    // Função para enviar o pedido via WhatsApp com mensagem formatada
    function enviarPedido() {
      const nome = document.getElementById("nome").value;
      const endereco = document.getElementById("endereco").value;
      const complemento = document.getElementById("complemento") ? document.getElementById("complemento").value : "";
      const pontoReferencia = document.getElementById("ponto-referencia") ? document.getElementById("ponto-referencia").value : "";
      const taxa = opcaoEntrega === "retirada" ? "0.00" : document.getElementById("taxa").value;
      const pagamento = document.getElementById("pagamento").value;
      const total = document.getElementById("total").value;
      const observacoes = document.getElementById("observacoes").value;
      const itensContainer = document.getElementById("itens-container").children;
      let itens = "";
      let temProdutoVazio = false;

      for (let i = 0; i < itensContainer.length; i++) {
        const item = itensContainer[i].children;
        const produtoSelecionado = item[0].value;
        if (produtoSelecionado === "") {
          temProdutoVazio = true;
          break;
        }
        const quantidade = item[1].value;
        const precoTotal = item[2].value;
        itens += `${produtos[produtoSelecionado].emoji} ${produtoSelecionado} x${quantidade} - R$ ${precoTotal}\n`;
      }

      if (temProdutoVazio) {
        alert("Por favor, selecione um produto ou remova os itens vazios do seu pedido.");
        return;
      }

      let mensagem = `*PEDIDO*\n\n📋 *Dados do Cliente:*\n- Nome: ${nome}\n- Endereço: ${endereco}\n`;
      if (complemento) mensagem += `- Complemento: ${complemento}\n`;
      if (pontoReferencia) {
        mensagem += `- Ponto de Referência: ${pontoReferencia}\n`;
      } else {
        alert("Por favor, preencha o Ponto de Referência para facilitar a localização.");
        return;
      }
      mensagem += `\n📦 *Itens do Pedido:*\n${itens}\n💵 *Forma de Pagamento:* ${pagamento}\n`;
      if (pagamento === 'PIX') {
        mensagem += `PIX - Chave: renimarfilho000@gmail.com\n`;
      } else if (pagamento === 'Cartão de Crédito' || pagamento === 'Cartão de Débito') {
        mensagem += `Cartão - Link para Pagamento: link.mercadopago.com.br/flowmize\n`;
      } else if (pagamento === 'Dinheiro') {
        mensagem += `Dinheiro\n`;
      }
      mensagem += `🚚 *Taxa de Entrega:* R$ ${taxa}\n🔴 *Total do Pedido:* R$ ${total}\n\n*Modo:* ${opcaoEntrega === "entrega" ? "Entrega" : "Retirada"}\n\n*Observações:* ${observacoes}`;

      const telefone = "98981729088";
      if (parseFloat(total) > 0) {
        const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(mensagem)}`;
        window.open(url, "_blank");
      } else {
        alert("Por favor, adicione pelo menos um item ao seu pedido.");
      }
    }

    // Função para remover um item do carrinho
    function removerItem(button) {
      const itemRow = button.parentElement;
      itemRow.remove();
      calcularTotal();
    }

    // Função para atualizar a mensagem de status (aberto/fechado)
    function atualizarStatus() {
      const statusContainer = document.getElementById("status-container");
      const now = new Date();
      const saoPauloTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const saoPauloTime = new Date(now.toLocaleString('pt-BR', { timeZone: saoPauloTimeZone }));
      const startTime = new Date(saoPauloTime.getFullYear(), saoPauloTime.getMonth(), saoPauloTime.getDate(), 18, 0, 0);
      const endTime = new Date(saoPauloTime.getFullYear(), saoPauloTime.getMonth(), saoPauloTime.getDate(), 22, 0, 0);
      if (saoPauloTime >= startTime && saoPauloTime <= endTime) {
        statusContainer.innerHTML = "Estamos Abertos 🥳";
        statusContainer.classList.add("aberto");
        statusContainer.classList.remove("fechado");
      } else {
        statusContainer.innerHTML = "Estamos Fechados 😕";
        statusContainer.classList.add("fechado");
        statusContainer.classList.remove("aberto");
      }
    }

    // Atualiza o status a cada segundo
    setInterval(atualizarStatus, 1000);
  </script>
</head>
<body>
  <div class="status-container" id="status-container">
    <!-- Aqui vai aparecer a mensagem "Estamos Abertos" ou "Estamos Fechados" -->
  </div>
  <form onsubmit="event.preventDefault(); enviarPedido();">
    <h1>PEDIDO 🍕🍔🥤🍟</h1>
    <label for="nome">Nome do Cliente:</label>
    <input type="text" id="nome" name="nome" placeholder="Digite seu nome" required>
    <label for="endereco">Endereço de Entrega:</label>
    <input type="text" id="endereco" name="endereco" placeholder="Cidade, Bairro, Rua, Número" required>
    <label for="complemento">Complemento (opcional):</label>
    <input type="text" id="complemento" name="complemento" placeholder="Ex: Apto. 101">
    <label for="ponto-referencia">Ponto de Referência:</label>
    <input type="text" id="ponto-referencia" name="ponto-referencia" placeholder="Ex: Em frente a padaria, ao lado do banco" required>
    <label>Itens do Pedido:</label>
    <div id="itens-container" class="itens-container">
      <!-- Os itens serão inseridos dinamicamente -->
    </div>
    <div class="add-item">
      <button type="button" onclick="adicionarItem()">Adicionar Item</button>
    </div>
    <label for="taxa">Taxa de Entrega (R$):</label>
    <input type="number" id="taxa" name="taxa" value="4.00" class="taxa-fixa" readonly>
    <label for="pagamento">Forma de Pagamento:</label>
    <select id="pagamento" name="pagamento" required>
      <option value="Dinheiro">Dinheiro</option>
      <option value="Cartão de Crédito">Cartão de Crédito</option>
      <option value="Cartão de Débito">Cartão de Débito</option>
      <option value="PIX">PIX</option>
    </select>
    <label for="observacoes">Observações:</label>
    <textarea id="observacoes" name="observacoes" placeholder="Digite suas observações" rows="4"></textarea>
    <!-- Botões para escolher Entrega ou Retirada -->
    <label>Opção:</label>
    <div id="opcao-entrega">
      <button type="button" id="btn-entrega" onclick="selecionarOpcao('entrega')" class="selected">Entrega</button>
      <button type="button" id="btn-retirada" onclick="selecionarOpcao('retirada')">Retirada</button>
    </div>
    <label for="total">Total:</label>
    <input type="number" id="total" name="total" placeholder="Total do Pedido" readonly>
    <button type="submit">Enviar Pedido</button>
  </form>
  <script>
    // Chama a função para carregar os produtos da planilha assim que o DOM estiver pronto
    window.addEventListener('DOMContentLoaded', function() {
      carregarProdutosDaPlanilha();
      atualizarStatus(); // Inicia a atualização do status
    });
  </script>
</body>
</html>
